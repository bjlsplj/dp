<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>驾车助手 - 附近充电桩与加油站</title>
    <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100%;
        }
        
        header {
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        
        header h1 {
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        header h1 i {
            font-size: 1.6rem;
        }
        
        .content {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        #mapContainer {
            flex: 1;
            height: 100%;
            min-width: 0;
        }
        
        .sidebar {
            width: 320px;
            background-color: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        
        .sidebar.collapsed {
            transform: translateX(100%);
        }
        
        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            color: white;
        }
        
        .sidebar-header h2 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toggle-sidebar {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50% 0 0 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .form-group {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
            font-size: 0.9rem;
        }
        
        input, select, button {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
        }
        
        #apiKeyInput {
            font-family: monospace;
            letter-spacing: 0.5px;
        }
        
        button {
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 5px;
        }
        
        #distanceSlider {
            flex: 1;
        }
        
        #distanceValue {
            min-width: 60px;
            text-align: center;
            font-weight: bold;
            color: #4b6cb7;
        }
        
        .results-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .result-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .result-item:hover {
            background-color: #f9f9f9;
        }
        
        .result-item.active {
            background-color: #e8f0fe;
            border-left: 3px solid #4b6cb7;
        }
        
        .result-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .result-info {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .result-distance {
            color: #4b6cb7;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .category-filter {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .category-btn {
            flex: 1;
            padding: 8px 10px;
            background-color: #f0f0f0;
            color: #666;
            border-radius: 20px;
            border: none;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .category-btn.active {
            background-color: #4b6cb7;
            color: white;
        }
        
        .icon {
            font-size: 1.2rem;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-open {
            background-color: #4CAF50;
        }
        
        .status-closed {
            background-color: #f44336;
        }
        
        .status-unknown {
            background-color: #ff9800;
        }
        
        .map-controls {
            position: absolute;
            top: 80px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 9;
        }
        
        .control-btn {
            width: 40px;
            height: 40px;
            background-color: white;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            color: #333;
            transition: all 0.2s;
        }
        
        .control-btn:hover {
            background-color: #f0f0f0;
            transform: scale(1.1);
        }
        
        .footer {
            text-align: center;
            padding: 12px;
            font-size: 0.8rem;
            color: #777;
            background-color: #f9f9f9;
            border-top: 1px solid #eee;
        }
        
        .footer a {
            color: #4b6cb7;
            text-decoration: none;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #777;
        }
        
        .empty-state i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 45%;
                position: absolute;
                bottom: 0;
                left: 0;
                z-index: 11;
                border-radius: 15px 15px 0 0;
            }
            
            .sidebar.collapsed {
                transform: translateY(100%);
            }
            
            .toggle-sidebar {
                top: -30px;
                right: 50%;
                transform: translateX(50%);
                border-radius: 15px 15px 0 0;
                width: 60px;
                height: 30px;
            }
            
            .map-controls {
                top: auto;
                bottom: calc(45% + 20px);
                right: 10px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-car"></i> 驾车助手 - 附近充电桩与加油站</h1>
        </header>
        
        <div class="content">
            <div id="mapContainer"></div>
            
            <div class="map-controls">
                <div class="control-btn" id="locateBtn" title="定位到我的位置">
                    <i class="fas fa-location-arrow"></i>
                </div>
                <div class="control-btn" id="refreshBtn" title="刷新附近设施">
                    <i class="fas fa-sync-alt"></i>
                </div>
            </div>
            
            <div class="sidebar" id="sidebar">
                <button class="toggle-sidebar" id="toggleSidebar">
                    <i class="fas fa-chevron-down"></i>
                </button>
                
                <div class="sidebar-header">
                    <h2><i class="fas fa-sliders-h"></i> 搜索设置</h2>
                </div>
                
                <div class="form-group">
                    <label for="apiKeyInput"><i class="fas fa-key"></i> 高德地图API Key</label>
                    <input type="text" id="apiKeyInput" placeholder="请输入您的高德API Key">
                    <p style="font-size: 0.8rem; margin-top: 8px; color: #ff9800;">
                        <i class="fas fa-info-circle"></i> 此应用需要您自己的API Key，请前往高德开放平台申请
                    </p>
                </div>
                
                <div class="form-group">
                    <label for="distanceSlider"><i class="fas fa-ruler"></i> 搜索距离: <span id="distanceValue">5</span> 公里</label>
                    <div class="slider-container">
                        <input type="range" id="distanceSlider" min="1" max="20" value="5" step="1">
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="category-filter">
                        <button class="category-btn active" data-type="all">
                            <i class="fas fa-th"></i> 全部
                        </button>
                        <button class="category-btn" data-type="charging">
                            <i class="fas fa-charging-station"></i> 充电桩
                        </button>
                        <button class="category-btn" data-type="gas">
                            <i class="fas fa-gas-pump"></i> 加油站
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <button id="searchBtn">
                        <i class="fas fa-search"></i> 搜索附近设施
                    </button>
                </div>
                
                <div class="results-container" id="resultsContainer">
                    <div class="empty-state" id="emptyState">
                        <i class="fas fa-map-marked-alt"></i>
                        <h3>等待搜索</h3>
                        <p>输入您的API Key并点击搜索按钮，查看附近的充电桩和加油站</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>使用高德地图API | 请确保您已申请并输入有效的API Key | 
                <a href="https://lbs.amap.com/api/javascript-api/guide/services/autocomplete" target="_blank">如何申请API Key?</a>
            </p>
        </div>
    </div>

    <script src="https://webapi.amap.com/maps?v=2.0&key=YOUR_DEFAULT_KEY60c60a0f7da343586574d047780d5eb0&plugin=AMap.PlaceSearch,AMap.Geolocation"></script>
    <script>
        // 全局变量
        let map = null;
        let geolocation = null;
        let placeSearch = null;
        let currentPosition = null;
        let markers = [];
        let results = [];
        let userApiKey = '';
        let selectedCategory = 'all';
        
        // 初始化函数
        function initApp() {
            // 尝试从本地存储加载API Key
            const savedApiKey = localStorage.getItem('amap_api_key');
            if (savedApiKey) {
                document.getElementById('apiKeyInput').value = savedApiKey;
                userApiKey = savedApiKey;
            }
            
            // 初始化地图（使用默认key，用户输入后会重新加载）
            initMap('YOUR_DEFAULT_KEY');
            
            // 绑定事件
            bindEvents();
            
            // 更新距离显示
            updateDistanceValue();
        }
        
        // 初始化地图
        function initMap(apiKey) {
            // 移除旧的地图脚本（如果需要重新加载）
            const oldScript = document.querySelector('script[src*="amap.com"]');
            if (oldScript) {
                oldScript.remove();
            }
            
            // 创建新的地图脚本
            const script = document.createElement('script');
            script.src = `https://webapi.amap.com/maps?v=2.0&key=${apiKey}&plugin=AMap.PlaceSearch,AMap.Geolocation`;
            script.onload = function() {
                // 创建地图实例
                map = new AMap.Map('mapContainer', {
                    zoom: 13,
                    center: [116.397428, 39.90923], // 默认中心点（北京）
                    resizeEnable: true
                });
                
                // 添加地图控件
                AMap.plugin(['AMap.ToolBar', 'AMap.Scale'], function() {
                    map.addControl(new AMap.ToolBar());
                    map.addControl(new AMap.Scale());
                });
                
                // 初始化定位插件
                geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true,
                    timeout: 10000,
                    buttonPosition: 'RB',
                    buttonOffset: new AMap.Pixel(10, 20),
                    zoomToAccuracy: true,
                    useNative: false
                });
                map.addControl(geolocation);
                
                // 尝试获取当前位置
                getUserLocation();
                
                // 初始化地点搜索插件
                placeSearch = new AMap.PlaceSearch({
                    pageSize: 50,
                    pageIndex: 1,
                    city: '全国',
                    map: map,
                    panel: 'resultsContainer',
                    autoFitView: true
                });
                
                console.log('地图初始化完成，使用API Key:', apiKey);
            };
            
            script.onerror = function() {
                alert('加载地图失败，请检查API Key是否正确');
            };
            
            document.head.appendChild(script);
        }
        
        // 绑定事件
        function bindEvents() {
            // API Key输入变化
            document.getElementById('apiKeyInput').addEventListener('change', function() {
                userApiKey = this.value.trim();
                if (userApiKey) {
                    localStorage.setItem('amap_api_key', userApiKey);
                }
            });
            
            // 距离滑块
            document.getElementById('distanceSlider').addEventListener('input', updateDistanceValue);
            
            // 搜索按钮
            document.getElementById('searchBtn').addEventListener('click', searchNearbyFacilities);
            
            // 分类筛选按钮
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedCategory = this.dataset.type;
                    filterResultsByCategory();
                });
            });
            
            // 定位按钮
            document.getElementById('locateBtn').addEventListener('click', getUserLocation);
            
            // 刷新按钮
            document.getElementById('refreshBtn').addEventListener('click', searchNearbyFacilities);
            
            // 侧边栏切换
            document.getElementById('toggleSidebar').addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('collapsed');
                const icon = this.querySelector('i');
                if (sidebar.classList.contains('collapsed')) {
                    icon.className = 'fas fa-chevron-up';
                } else {
                    icon.className = 'fas fa-chevron-down';
                }
            });
        }
        
        // 更新距离显示
        function updateDistanceValue() {
            const slider = document.getElementById('distanceSlider');
            const valueDisplay = document.getElementById('distanceValue');
            valueDisplay.textContent = slider.value;
        }
        
        // 获取用户位置
        function getUserLocation() {
            if (!geolocation) {
                alert('定位功能未初始化，请先输入有效的API Key');
                return;
            }
            
            geolocation.getCurrentPosition(function(status, result) {
                if (status === 'complete') {
                    currentPosition = {
                        lng: result.position.lng,
                        lat: result.position.lat
                    };
                    
                    // 将地图中心移动到当前位置
                    map.setCenter([currentPosition.lng, currentPosition.lat]);
                    map.setZoom(15);
                    
                    console.log('定位成功:', currentPosition);
                } else {
                    console.error('定位失败:', result);
                    alert('获取位置失败，请确保已开启位置权限');
                    
                    // 使用默认位置（北京）
                    currentPosition = { lng: 116.397428, lat: 39.90923 };
                    map.setCenter([currentPosition.lng, currentPosition.lat]);
                    map.setZoom(13);
                }
            });
        }
        
        // 搜索附近设施
        function searchNearbyFacilities() {
            if (!userApiKey) {
                alert('请输入您的高德地图API Key');
                document.getElementById('apiKeyInput').focus();
                return;
            }
            
            if (!currentPosition) {
                alert('无法获取当前位置，请先允许位置权限或稍后重试');
                return;
            }
            
            // 如果地图未初始化或使用的API Key与用户输入的不同，重新初始化
            if (!map || window.AMapKey !== userApiKey) {
                window.AMapKey = userApiKey;
                initMap(userApiKey);
                
                // 稍等地图初始化完成
                setTimeout(searchNearbyFacilities, 1000);
                return;
            }
            
            const distance = parseInt(document.getElementById('distanceSlider').value);
            
            // 清除之前的标记
            clearMarkers();
            
            // 搜索充电桩
            searchPlaces('充电桩', distance, 'charging');
            
            // 搜索加油站
            searchPlaces('加油站', distance, 'gas');
            
            // 隐藏空状态
            document.getElementById('emptyState').style.display = 'none';
        }
        
        // 搜索特定类型的地点
        function searchPlaces(keyword, distance, type) {
            if (!placeSearch) {
                console.error('地点搜索插件未初始化');
                return;
            }
            
            const center = new AMap.LngLat(currentPosition.lng, currentPosition.lat);
            
            placeSearch.searchNearBy(keyword, center, distance * 1000, function(status, result) {
                if (status === 'complete' && result.info === 'OK') {
                    // 处理搜索结果
                    const places = result.poiList.pois;
                    console.log(`找到${places.length}个${keyword}`);
                    
                    // 为每个地点创建标记
                    places.forEach(place => {
                        // 添加标记
                        const marker = addMarker(place, type);
                        
                        // 保存结果
                        results.push({
                            id: place.id,
                            name: place.name,
                            address: place.address,
                            distance: place.distance,
                            location: place.location,
                            tel: place.tel || '无联系电话',
                            type: type,
                            businessStatus: place.businessStatus || '未知'
                        });
                    });
                    
                    // 显示结果列表
                    displayResultsList();
                    
                    // 调整地图视野以显示所有标记
                    if (markers.length > 0) {
                        map.setFitView(markers);
                    }
                } else {
                    console.error(`搜索${keyword}失败:`, result);
                }
            });
        }
        
        // 添加地图标记
        function addMarker(place, type) {
            // 根据类型设置不同的图标
            let iconUrl, size;
            if (type === 'charging') {
                iconUrl = 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png';
                size = new AMap.Size(24, 34);
            } else {
                iconUrl = 'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png';
                size = new AMap.Size(24, 34);
            }
            
            const marker = new AMap.Marker({
                position: [place.location.lng, place.location.lat],
                title: place.name,
                map: map,
                icon: new AMap.Icon({
                    image: iconUrl,
                    size: size
                }),
                offset: new AMap.Pixel(-12, -34)
            });
            
            // 添加点击事件
            marker.on('click', function() {
                // 在侧边栏中高亮对应的结果项
                highlightResultItem(place.id);
                
                // 显示信息窗口
                const infoWindow = new AMap.InfoWindow({
                    content: `<div style="padding: 10px;">
                        <h3 style="margin: 0 0 5px 0;">${place.name}</h3>
                        <p style="margin: 0 0 5px 0; color: #666;">${place.address || '地址不详'}</p>
                        <p style="margin: 0 0 5px 0;">距离: ${place.distance}米</p>
                        <p style="margin: 0 0 5px 0;">电话: ${place.tel || '无'}</p>
                        <p style="margin: 0;">类型: ${type === 'charging' ? '充电桩' : '加油站'}</p>
                    </div>`,
                    offset: new AMap.Pixel(0, -34)
                });
                
                infoWindow.open(map, marker.getPosition());
            });
            
            markers.push(marker);
            return marker;
        }
        
        // 显示结果列表
        function displayResultsList() {
            const container = document.getElementById('resultsContainer');
            
            // 清空容器（除了空状态）
            const emptyState = document.getElementById('emptyState');
            container.innerHTML = '';
            container.appendChild(emptyState);
            
            // 按距离排序
            results.sort((a, b) => a.distance - b.distance);
            
            // 创建结果项
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'result-item';
                item.dataset.id = result.id;
                item.dataset.type = result.type;
                
                // 状态指示器
                let statusClass, statusText;
                if (result.businessStatus === '营业中') {
                    statusClass = 'status-open';
                    statusText = '营业中';
                } else if (result.businessStatus === '暂停营业') {
                    statusClass = 'status-closed';
                    statusText = '暂停营业';
                } else {
                    statusClass = 'status-unknown';
                    statusText = '状态未知';
                }
                
                // 类型图标
                let typeIcon, typeText;
                if (result.type === 'charging') {
                    typeIcon = 'fas fa-charging-station';
                    typeText = '充电桩';
                } else {
                    typeIcon = 'fas fa-gas-pump';
                    typeText = '加油站';
                }
                
                item.innerHTML = `
                    <div class="result-title">
                        <i class="${typeIcon}"></i>
                        <span>${result.name}</span>
                    </div>
                    <div class="result-info">
                        <span class="status-indicator ${statusClass}"></span>
                        <span>${statusText}</span>
                    </div>
                    <div class="result-info">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${result.address || '地址不详'}</span>
                    </div>
                    <div class="result-info">
                        <i class="fas fa-phone"></i>
                        <span>${result.tel}</span>
                    </div>
                    <div class="result-distance">
                        <i class="fas fa-walking"></i>
                        <span>${result.distance}米</span>
                    </div>
                `;
                
                // 添加点击事件
                item.addEventListener('click', function() {
                    // 高亮此项
                    highlightResultItem(result.id);
                    
                    // 将地图中心移动到该位置
                    map.setCenter([result.location.lng, result.location.lat]);
                    map.setZoom(16);
                    
                    // 显示标记的点击效果
                    const marker = markers.find(m => 
                        m.getPosition().lng === result.location.lng && 
                        m.getPosition().lat === result.location.lat
                    );
                    if (marker) {
                        marker.emit('click', {target: marker});
                    }
                });
                
                container.appendChild(item);
            });
            
            // 应用类型筛选
            filterResultsByCategory();
        }
        
        // 高亮结果项
        function highlightResultItem(id) {
            // 移除所有高亮
            document.querySelectorAll('.result-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 高亮指定项
            const targetItem = document.querySelector(`.result-item[data-id="${id}"]`);
            if (targetItem) {
                targetItem.classList.add('active');
                targetItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        // 按类别筛选结果
        function filterResultsByCategory() {
            document.querySelectorAll('.result-item').forEach(item => {
                if (selectedCategory === 'all' || item.dataset.type === selectedCategory) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // 清除所有标记
        function clearMarkers() {
            markers.forEach(marker => {
                marker.setMap(null);
            });
            markers = [];
            results = [];
        }
        
        // 页面加载完成后初始化应用
        window.onload = initApp;
    </script>
</body>
</html>